<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
<meta charset="UTF-8">
<title>Product AJAX</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="p-3">
	<div class="container">
		<h3 class="mb-3">Quản lý Product (AJAX)</h3>

		<div class="row g-2 mb-2">
			<div class="col-sm-4">
				<input id="kw" class="form-control" placeholder="Tìm theo tên...">
			</div>
			<div class="col-sm-4">
				<select id="catFilter" class="form-select"><option value="">--Tất
						cả danh mục--</option></select>
			</div>
			<div class="col-sm-4 d-flex gap-2">
				<button id="btnSearch" class="btn btn-primary">Tìm</button>
				<button id="btnNew" class="btn btn-success">Thêm</button>
			</div>
		</div>

		<table class="table table-bordered align-middle">
			<thead>
				<tr>
					<th>ID</th>
					<th>Tên</th>
					<th>Giá</th>
					<th>Danh mục</th>
					<th style="width: 140px">Thao tác</th>
				</tr>
			</thead>
			<tbody id="tbody"></tbody>
		</table>
		<nav>
			<ul id="pagination" class="pagination"></ul>
		</nav>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="prdModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 id="modalTitle" class="modal-title">Product</h5>
					<button class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<input type="hidden" id="prdId">
					<div class="mb-2">
						<label class="form-label">Tên</label> <input id="prdName"
							class="form-control">
						<div class="invalid-feedback" id="nameErr"></div>
					</div>
					<div class="mb-2">
						<label class="form-label">Giá</label> <input id="prdPrice"
							class="form-control" type="number" step="0.01" min="0">
						<div class="invalid-feedback" id="priceErr"></div>
					</div>
					<div class="mb-2">
						<label class="form-label">Danh mục</label> <select
							id="prdCategory" class="form-select"></select>
						<div class="invalid-feedback" id="catErr"></div>
					</div>
					<div class="text-danger small" id="serverErr"></div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
					<button id="btnSave" class="btn btn-primary">Lưu</button>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
  let page=0,size=5,keyword="";
  let modal;

  window.addEventListener('DOMContentLoaded', ()=>{
    modal = new bootstrap.Modal('#prdModal');
    loadCategoriesForFilter();
    loadData();

    document.getElementById('btnSearch').onclick = ()=>{
      keyword = document.getElementById('kw').value.trim();
      page = 0; loadData();
    };
    document.getElementById('catFilter').onchange = ()=>{ page=0; loadData(); };
    document.getElementById('btnNew').onclick = openNew;
    document.getElementById('btnSave').onclick = saveData;
  });

  async function loadCategoriesForFilter(){
    const res = await fetch('/api/categories?size=1000');
    const pg = await res.json();
    const opts = pg.content.map(c=> `<option value="${c.id}">${c.name}</option>`).join('');
    document.getElementById('catFilter').innerHTML = `<option value="">--Tất cả danh mục--</option>` + opts;
    document.getElementById('prdCategory').innerHTML = opts;
  }

  async function loadData(){
    const res = await fetch(`/api/products?keyword=${encodeURIComponent(keyword)}&page=${page}&size=${size}&sort=id,desc`);
    const pg = await res.json();
    const catFilter = document.getElementById('catFilter').value;
    const data = pg.content.filter(p => !catFilter || (p.category && String(p.category.id)===catFilter));
    document.getElementById('tbody').innerHTML = data.map(p=>`
      <tr>
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${formatMoney(p.price)}</td>
        <td>${p.category? p.category.name : ''}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="openEdit(${p.id})">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="removePrd(${p.id})">Xoá</button>
        </td>
      </tr>
    `).join('');
    renderPagination(pg);
  }

  function renderPagination(pg){
    const ul = document.getElementById('pagination');
    let html='';
    for (let i=0;i<pg.totalPages;i++){
      html += `<li class="page-item ${i===pg.number?'active':''}">
                 <button class="page-link" onclick="gotoPage(${i})">${i+1}</button>
               </li>`;
    }
    ul.innerHTML = html || `<li class="page-item active"><span class="page-link">1</span></li>`;
  }
  function gotoPage(i){ page=i; loadData(); }
  const formatMoney = v => new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(v ?? 0);

  function openNew(){
    document.getElementById('modalTitle').innerText='Thêm Product';
    document.getElementById('prdId').value='';
    document.getElementById('prdName').value='';
    document.getElementById('prdPrice').value='0';
    document.getElementById('prdCategory').selectedIndex = 0;
    clearErr();
    modal.show();
  }

  async function openEdit(id){
    const res = await fetch(`/api/products/${id}`);
    if (res.status===404){ alert('Không tìm thấy'); return; }
    const p = await res.json();
    document.getElementById('modalTitle').innerText='Sửa Product';
    document.getElementById('prdId').value = p.id;
    document.getElementById('prdName').value = p.name;
    document.getElementById('prdPrice').value = p.price;
    document.getElementById('prdCategory').value = p.category ? p.category.id : '';
    clearErr();
    modal.show();
  }

  function clearErr(){
    ['prdName','prdPrice','prdCategory'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
    ['nameErr','priceErr','catErr','serverErr'].forEach(id => document.getElementById(id).innerText='');
  }

  async function saveData(){
    clearErr();
    const id = document.getElementById('prdId').value;
    const payload = {
      name: document.getElementById('prdName').value.trim(),
      price: Number(document.getElementById('prdPrice').value),
      categoryId: Number(document.getElementById('prdCategory').value)
    };
    const method = id? 'PUT':'POST';
    const url = id? `/api/products/${id}` : '/api/products';
    const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (res.ok){ modal.hide(); loadData(); alert('Đã lưu'); }
    else {
      let errText = 'Lỗi không xác định';
      try {
        const err = await res.json();
        if (err.fieldErrors){
          if (err.fieldErrors.name){ document.getElementById('prdName').classList.add('is-invalid'); document.getElementById('nameErr').innerText = err.fieldErrors.name; }
          if (err.fieldErrors.price){ document.getElementById('prdPrice').classList.add('is-invalid'); document.getElementById('priceErr').innerText = err.fieldErrors.price; }
          if (err.fieldErrors.categoryId){ document.getElementById('prdCategory').classList.add('is-invalid'); document.getElementById('catErr').innerText = err.fieldErrors.categoryId; }
          return;
        }
        if (err.message) errText = err.message;
      } catch(e){ /* ignore */ }
      document.getElementById('serverErr').innerText = errText;
    }
  }

  async function removePrd(id){
    if (!confirm('Xoá product này?')) return;
    const res = await fetch(`/api/products/${id}`, {method:'DELETE'});
    if (res.status===204){ loadData(); alert('Đã xoá'); }
    else alert('Không xoá được (có thể vi phạm ràng buộc).');
  }
</script>
</body>
</html>
