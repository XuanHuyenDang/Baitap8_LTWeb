<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Category AJAX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">
<div class="container">
  <h4>Quản lý Category (AJAX)</h4>
  <div class="d-flex gap-2 mb-2">
    <input id="kw" class="form-control" placeholder="Tìm theo tên...">
    <button id="btnSearch" class="btn btn-primary">Tìm</button>
    <button id="btnNew" class="btn btn-success">Thêm</button>
  </div>

  <table class="table table-bordered align-middle">
    <thead><tr><th>ID</th><th>Tên</th><th>Mô tả</th><th style="width:140px">Thao tác</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
  <nav><ul id="pagination" class="pagination"></ul></nav>
</div>

<!-- Modal -->
<div class="modal fade" id="catModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 id="modalTitle" class="modal-title">Category</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="catId">
      <div class="mb-2">
        <label class="form-label">Tên</label>
        <input id="catName" class="form-control">
      </div>
      <div class="mb-2">
        <label class="form-label">Mô tả</label>
        <textarea id="catDesc" class="form-control"></textarea>
      </div>
      <div class="text-danger small" id="serverErr"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      <button id="btnSave" class="btn btn-primary">Lưu</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let page=0,size=5,keyword="";
  let modal;

  window.addEventListener('DOMContentLoaded', ()=>{
    modal = new bootstrap.Modal('#catModal');
    loadData();
    document.getElementById('btnSearch').onclick = ()=>{keyword=document.getElementById('kw').value.trim(); page=0; loadData();};
    document.getElementById('btnNew').onclick = openNew;
    document.getElementById('btnSave').onclick = saveData;
  });

  async function loadData(){
    const res = await fetch(`/api/categories?keyword=${encodeURIComponent(keyword)}&page=${page}&size=${size}&sort=id,desc`);
    const pg = await res.json();
    document.getElementById('tbody').innerHTML = pg.content.map(c=>`
      <tr>
        <td>${c.id}</td>
        <td>${c.name}</td>
        <td>${c.description??''}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="openEdit(${c.id})">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="removeCat(${c.id})">Xoá</button>
        </td>
      </tr>`).join('');
    renderPagination(pg);
  }

  function renderPagination(pg){
    const ul = document.getElementById('pagination');
    let html='';
    for (let i=0;i<pg.totalPages;i++){
      html += `<li class="page-item ${i===pg.number?'active':''}">
                 <button class="page-link" onclick="gotoPage(${i})">${i+1}</button>
               </li>`;
    }
    ul.innerHTML = html || `<li class="page-item active"><span class="page-link">1</span></li>`;
  }
  function gotoPage(p){ page=p; loadData(); }

  function openNew(){
    document.getElementById('modalTitle').innerText='Thêm Category';
    document.getElementById('catId').value='';
    document.getElementById('catName').value='';
    document.getElementById('catDesc').value='';
    document.getElementById('serverErr').innerText='';
    modal.show();
  }

  async function openEdit(id){
    const res = await fetch(`/api/categories/${id}`);
    if (res.status===404){ alert('Không tìm thấy'); return; }
    const c = await res.json();
    document.getElementById('modalTitle').innerText='Sửa Category';
    document.getElementById('catId').value=c.id;
    document.getElementById('catName').value=c.name;
    document.getElementById('catDesc').value=c.description ?? '';
    document.getElementById('serverErr').innerText='';
    modal.show();
  }

  async function saveData(){
    const id = document.getElementById('catId').value;
    const payload = {
      id: id? Number(id): null,
      name: document.getElementById('catName').value.trim(),
      description: document.getElementById('catDesc').value.trim()
    };
    const method = id? 'PUT':'POST';
    const url = id? `/api/categories/${id}` : '/api/categories';
    const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (res.ok){ modal.hide(); loadData(); alert('Đã lưu'); }
    else {
      const msg = await res.text().catch(()=> 'Lỗi');
      document.getElementById('serverErr').innerText = msg || 'Lỗi không xác định';
    }
  }

  async function removeCat(id){
    if (!confirm('Xoá category này?')) return;
    const res = await fetch(`/api/categories/${id}`, {method:'DELETE'});
    if (res.status===204){ loadData(); alert('Đã xoá'); }
    else alert('Không xoá được.');
  }
</script>
</body>
</html>
